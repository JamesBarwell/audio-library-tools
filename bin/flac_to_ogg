#!/bin/bash

set -e

SAVEIFS=$IFS
IFS=$(echo -en "\n\b")

dir=$(readlink -f $1)
output=$(readlink -f $2)
# Most users agree -q 5 achieves transparency, if the source is the original or
# lossless: http://wiki.hydrogenaud.io/index.php?title=Recommended_Ogg_Vorbis
quality=${3:-5}

if [ ! -d "$dir" ] || [ ! -d "$output" ]; then
    echo "Directory not found"
    exit 1
fi

output_path="$output/${dir##*/}"
echo 'Creating directory at' $output_path
mkdir -p "$output_path"

flacs=$(find $dir -type f -name "*.flac" | sort --numeric-sort)

for flac_path in $flacs
do
    flac_name=${flac_path##*/}
    ogg_name="${flac_name%flac}ogg"
    output_ogg_path="$output_path/$ogg_name"

    echo "Converting $flac_path to $output_ogg_path"
    flac --stdout --silent --decode $flac_path \
        | oggenc - --quality $quality --output $output_ogg_path
done

IFS=$SAVEIFS

exit 0
